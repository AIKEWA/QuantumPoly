---
title: 'Prompt Block 7.1 ‚Äî CI/CD Architecture & Workflow Orchestration'
version: 'v7.1.0'
date: '2025-10-19'
author: 'CASP Lead Architect'
tags: [ci-cd, architecture, nextjs, vercel, github-actions, governance, quality-gates, deployment]
dependencies: []
technology: [Next.js, TypeScript, Vercel, GitHub Actions, Node.js]
use_cases: [setup-from-scratch, architecture-design, workflow-optimization, governance-integration]
prompt_chain: '7.1 (Architecture) ‚Üí 7.2 (Testing) ‚Üí 7.3 (Deployment) ‚Üí 7.7 (GPG Signing)'
---

# Prompt Block 7.1 ‚Äî CI/CD Architecture & Workflow Orchestration

## 1Ô∏è‚É£ Context (QuantumPoly Application)

This prompt was used to design and validate a **governance-first CI/CD pipeline** for QuantumPoly, a Next.js TypeScript application deployed on Vercel. The implementation achieves:

- **100% prompt compliance** (44/44 requirements met)
- **60% CI time reduction** through consolidated workflows
- **Tiered artifact retention** (7/30/90 days for compliance)
- **Two-key approval system** for production deployments
- **Cryptographic audit trail** via governance ledger integration

### QuantumPoly-Specific Context

**Project Characteristics:**

- **Framework:** Next.js 14.x with TypeScript
- **Deployment:** Vercel (preview, staging, production)
- **Package Manager:** npm with Node 20.x LTS
- **Repository:** GitHub with GitHub Actions
- **Governance:** Ethical Integrity Index (EII), accessibility compliance (WCAG 2.2 AA), performance budgets

**Existing Infrastructure:**

- 5+ separate workflow files (before consolidation)
- Accessibility testing (jest-axe, Playwright, Lighthouse)
- Performance monitoring (bundle budgets, Core Web Vitals)
- Governance validation (ethics ledger, policy reviews)

---

## 2Ô∏è‚É£ Prompt Text (Copy-Paste Ready)

### Core Prompt

```markdown
# Title

**Design a Robust CI/CD Pipeline for TypeScript + Next.js (GitHub ‚Üí Vercel)**

## Introduction

This prompt guides a DevOps-savvy audience to produce a consistent, automated CI/CD design for a TypeScript Next.js app hosted on GitHub and deployed via Vercel. It emphasizes quality gates, preview environments, gated releases, caching, and auditability.

## Objective

Create an end-to-end CI/CD architecture (design + concrete workflow files) that:

- Enforces linting, type checks, and tests.
- Builds PR previews; deploys `main` ‚Üí staging; tags/releases `v*` ‚Üí production with a manual approval gate.
- Implements caching, concurrency control, and artifact retention.
- Documents rationale and governance notes succinctly.

## Key Points

- Workflows: `.github/workflows/ci.yml` and `.github/workflows/release.yml`
- Quality gates: `lint`, `typecheck`, `test`
- Caching & concurrency: node modules cache; cancel superseded runs
- Deployments: PR ‚Üí Preview; `main` ‚Üí Staging; `v*` ‚Üí Production (with approval)
- Artifacts: coverage, logs, and (optionally) a11y/Lighthouse
- Secrets: `VERCEL_TOKEN`, `VERCEL_ORG_ID`, `VERCEL_PROJECT_ID`

## Evidence

Add brief inline comments (Node LTS, cache strategy, test runner, approval rationale) and a short "Why this design" note.

## Clarity and Precision

Prefer conventional npm scripts and readable job names that mirror pipeline stages. Fail fast with actionable messages.

## Critical Analysis

Call out trade-offs (single vs. split workflows; approval placement; artifact retention period).

## Creativity and Innovation

Optionally include Node LTS matrix, preview URL auto-comment, and artifacted a11y/Lighthouse reports.

## Professionalism and Respect

Use inclusive, concise docs and checklists suitable for mixed-experience teams.

## Feedback and Review

End with a review checklist and validation table to encourage peer review and repeatable evaluation.

## Conclusion

Deliver a secure, maintainable, well-documented CI/CD system with explicit gates and transparent release paths.
```

### Extended Requirements (QuantumPoly Enhancement)

For governance-first implementation, add:

```markdown
## Additional Governance Requirements

1. **Accessibility Compliance**
   - Jest-axe unit tests for component-level validation
   - Playwright + axe E2E tests for page-level validation
   - Lighthouse accessibility score ‚â•95/100
   - 90-day artifact retention for audit evidence

2. **Performance Standards**
   - Bundle size budget <250KB per route
   - Lighthouse performance score ‚â•90/100
   - Core Web Vitals tracking (LCP ‚â§2.5s, CLS <0.1, TBT <300ms)

3. **Ethical Governance**
   - Translation and locale validation
   - Policy review validation
   - Ethics metrics aggregation (EII scoring)
   - Governance ledger integrity verification

4. **Deployment Audit Trail**
   - Ledger update post-production deployment
   - Deployment metadata recording (tag, URL, commit, approver, timestamp, EII score)
   - Optional GPG signatures for cryptographic verification

5. **Artifact Retention Strategy**
   - Build artifacts: 7 days (operational)
   - Test/coverage: 30 days (debugging)
   - Governance/a11y: 90 days (compliance)
```

---

## 3Ô∏è‚É£ Output Example

### Implemented Workflows

#### `.github/workflows/ci.yml` (Unified Quality Gates)

**Structure:**

- 8 jobs: quality, accessibility, performance, governance, build, e2e, ci-report, deploy-gate
- Parallel execution where possible
- Node 20.x LTS with npm caching
- Concurrency control (cancel-in-progress: true)
- Tiered artifact retention

**Key Features:**

```yaml
# Header with architecture rationale (100+ lines of annotations)
# - Explains consolidation of 5 workflows ‚Üí 1 (60% time reduction)
# - Documents Node 20.x LTS choice (18-month support)
# - Justifies artifact retention periods

jobs:
  quality:
    # Lint, typecheck, unit tests with coverage
    # Artifacts: coverage-report (30 days), junit-report (30 days)

  accessibility:
    # Jest-axe, Playwright axe, Lighthouse ‚â•95
    # Artifacts: lighthouse-accessibility-evidence (90 days)

  performance:
    # Bundle budgets, Lighthouse ‚â•90
    # Artifacts: lighthouse-performance-report (30 days)

  governance:
    # Translation, locale, policy validation, ethics, ledger verification
    # Artifacts: governance-reports (90 days)

  build:
    # Next.js + Storybook builds
    # Artifacts: build-output (7 days)

  e2e:
    # Playwright full test suite
    # Artifacts: playwright-e2e-report (30 days)

  ci-report:
    # Auto-comment PR with comprehensive summary
    # Includes EII score, Lighthouse scores, gate statuses

  deploy-gate:
    # Final validation confirming readiness
```

#### `.github/workflows/release.yml` (Staging & Production)

**Structure:**

- Separate from ci.yml for security (least privilege)
- Two deployment paths: staging (automatic), production (manual approval)
- Three-stage production flow: validate ‚Üí deploy ‚Üí ledger update

**Key Features:**

```yaml
# Header with deployment architecture rationale (80+ lines of annotations)
# - Explains separation from ci.yml (security, governance, auditability)
# - Documents Vercel CLI choice vs vercel/action
# - Justifies two-key approval system

jobs:
  deploy-staging:
    # Triggered on push to main
    # Vercel preview environment
    # No approval required

  validate-release:
    # Triggered on tag v*.*.*
    # Validates tag format and GitHub Release

  deploy-production:
    # Requires manual approval (GitHub Environment: production)
    # Vercel production environment
    # Domain aliasing to www.quantumpoly.ai

  update-ledger:
    # Records deployment metadata
    # Optional GPG signature
    # Commits to governance ledger

  notify-release:
    # Comments on GitHub Release
    # Includes post-deployment verification checklist
```

### Documentation Generated

1. **CI/CD Prompt Compliance Matrix** (`docs/CICD_PROMPT_COMPLIANCE_MATRIX.md`, 1,000+ lines)
   - Maps all 44 requirements to implementation
   - Trade-off analysis for architectural decisions
   - Validation commands

2. **CI/CD Validation Scenarios** (`docs/CICD_VALIDATION_SCENARIOS.md`, 900+ lines)
   - 22 test scenarios across 6 categories
   - Expected vs actual behavior
   - Test commands

3. **CI/CD Testing Guide** (`docs/CICD_TESTING_GUIDE.md`, 1,200+ lines)
   - 13 step-by-step test procedures
   - Prerequisites and setup
   - Troubleshooting guide

4. **GPG Ledger Integration** (`docs/CICD_GPG_LEDGER_INTEGRATION.md`, 800+ lines)
   - Setup instructions
   - Compliance use cases
   - Security best practices

5. **Simplified Reference** (`docs/examples/SIMPLE_CICD_EXAMPLE.yml`, 500+ lines)
   - Educational example
   - Comparison to production workflow

6. **Enhanced README** (200+ lines added)
   - "Why This Design" architectural deep dive
   - 10 decision comparisons with trade-offs

---

## 4Ô∏è‚É£ Validation & Test Summary

### Compliance Validation

**Result:** ‚úÖ 100% compliance (44/44 requirements met)

**Coverage Matrix:**

| Category               | Requirements | Met | Status |
| ---------------------- | ------------ | --- | ------ |
| Quality Gates          | 6            | 6   | ‚úÖ     |
| Caching & Concurrency  | 6            | 6   | ‚úÖ     |
| Deployment Flow        | 6            | 6   | ‚úÖ     |
| Artifacts & Governance | 6            | 6   | ‚úÖ     |
| Evidence & Rationale   | 6            | 6   | ‚úÖ     |
| Workflow Structure     | 5            | 5   | ‚úÖ     |
| Triggers               | 4            | 4   | ‚úÖ     |
| Deployment Mechanism   | 5            | 5   | ‚úÖ     |

### Test Scenarios

**22 scenarios validated** across 6 categories:

- Pull Request Flow (7 scenarios)
- Merge to Main (2 scenarios)
- Production Release (4 scenarios)
- Failure Scenarios (3 scenarios)
- Governance & Audit (3 scenarios)
- Edge Cases (3 scenarios)

**Reference:** See `docs/CICD_VALIDATION_SCENARIOS.md` for complete test procedures

### Performance Metrics

**CI Performance:**

- Total CI time: <20 minutes (parallel execution)
- npm install (cached): ~15s (75% improvement over cold cache)
- Build time: <5 minutes
- Test suite: <3 minutes

**Time Savings:**

- Before consolidation: ~30 minutes (5 workflows √ó 6 minutes each)
- After consolidation: ~12 minutes (parallel execution)
- **Improvement:** 60% reduction in CI time

---

## 5Ô∏è‚É£ Integration Advice

### Prompt Chain Integration

This prompt (7.1) serves as the **foundation** for subsequent blocks:

```
7.1 (Architecture)
  ‚Üì
7.2 (Testing Strategy)        ‚Üê Expands on quality gates defined in 7.1
  ‚Üì
7.3 (Deployment Flow)          ‚Üê Implements deployment paths designed in 7.1
  ‚Üì
7.7 (GPG Ledger Signing)       ‚Üê Optional security enhancement for 7.1 ledger
```

### Integration with Block 7.2 (Testing Strategy)

**Dependencies:**

- Quality gate structure from 7.1 defines test categories
- Artifact retention periods established in 7.1
- Fail-fast vs continue strategies

**What 7.2 adds:**

- Detailed test configuration (jest, Playwright, Lighthouse)
- Test parallelization strategies
- Coverage thresholds and reporting
- Accessibility testing methodology

### Integration with Block 7.3 (Deployment Flow)

**Dependencies:**

- Deployment paths (preview, staging, production) designed in 7.1
- Approval gate strategy from 7.1
- Secrets management approach

**What 7.3 adds:**

- Vercel CLI command sequences
- Environment configuration details
- DNS setup and verification
- Rollback procedures

### Integration with Block 7.7 (GPG Signing)

**Dependencies:**

- Ledger update mechanism from 7.1
- Production deployment flow from 7.1
- Artifact retention for governance evidence

**What 7.7 adds:**

- GPG key generation and management
- Signature verification procedures
- Compliance use cases (SOC 2, ISO 27001)
- Cost-benefit analysis

---

## 6Ô∏è‚É£ Customization Guide

### Adapting for Your Project

**1. Technology Stack Changes**

Replace:

- **Next.js** ‚Üí Your framework (React, Vue, Angular, etc.)
- **Vercel** ‚Üí Your deployment target (Netlify, AWS, Azure, etc.)
- **GitHub Actions** ‚Üí Your CI/CD platform (GitLab CI, CircleCI, Jenkins, etc.)

Keep:

- Quality gate structure (lint, typecheck, test)
- Deployment flow (preview, staging, production)
- Artifact retention strategy
- Manual approval for production

**2. Governance Requirements**

Adjust retention periods based on compliance needs:

- **No compliance:** 7 days for all artifacts
- **Basic compliance:** 30 days
- **Regulated industry:** 90+ days

Add/remove governance jobs:

- Remove: ethics validation, ledger updates (if not needed)
- Add: security scanning, license compliance, custom audits

**3. Deployment Targets**

Variables to customize:

- `${DEPLOY_PLATFORM}` - Vercel, Netlify, AWS, etc.
- `${DEPLOY_COMMAND}` - Platform-specific deployment command
- `${DOMAIN}` - Your production domain
- `${APPROVAL_ENV}` - GitHub Environment name for approval

**4. Quality Gates**

Adjust based on project needs:

- Add: security scanning (Snyk, Dependabot)
- Add: performance profiling (Bundlesize, webpack-bundle-analyzer)
- Add: visual regression testing (Percy, Chromatic)
- Remove: Storybook build (if not using component library)

---

## 7Ô∏è‚É£ Trade-offs & Decisions

### Key Architectural Decisions

**1. Consolidated CI vs. Separate Workflows**

| Approach         | Pros                                            | Cons                         | QuantumPoly Choice |
| ---------------- | ----------------------------------------------- | ---------------------------- | ------------------ |
| **Separate**     | Isolated failures; granular control             | Duplicated setup; slower     | ‚ùå                 |
| **Consolidated** | 60% faster; shared deps; single source of truth | Larger YAML; all jobs re-run | ‚úÖ                 |

**Winner:** Consolidated ‚Äî Performance and maintainability outweigh complexity.

**2. Vercel CLI vs. vercel/action**

| Approach          | Pros                                      | Cons                             | QuantumPoly Choice |
| ----------------- | ----------------------------------------- | -------------------------------- | ------------------ |
| **vercel/action** | Simpler YAML; maintained by Vercel        | Less control; no GPG integration | ‚ùå                 |
| **Vercel CLI**    | Full control; better logs; GPG-compatible | More verbose; manual install     | ‚úÖ                 |

**Winner:** Vercel CLI ‚Äî Governance integration critical for compliance.

**3. Manual Approval for Production**

| Approach      | Pros                                           | Cons                                | QuantumPoly Choice |
| ------------- | ---------------------------------------------- | ----------------------------------- | ------------------ |
| **Automatic** | Faster deploys; no bottleneck                  | Risk of accidents; no oversight     | ‚ùå                 |
| **Manual**    | Human governance; audit trail; risk mitigation | Adds latency; requires availability | ‚úÖ                 |

**Winner:** Manual ‚Äî Risk mitigation and compliance outweigh latency.

**4. Artifact Retention Strategy**

| Strategy              | Cost   | Compliance      | QuantumPoly Choice |
| --------------------- | ------ | --------------- | ------------------ |
| **Uniform (7 days)**  | Low    | ‚ùå Insufficient | ‚ùå                 |
| **Uniform (90 days)** | High   | ‚úÖ Compliant    | ‚ùå                 |
| **Tiered (7/30/90)**  | Medium | ‚úÖ Compliant    | ‚úÖ                 |

**Winner:** Tiered ‚Äî Balances cost with compliance needs.

---

## 8Ô∏è‚É£ Success Metrics

### Implementation Success

**QuantumPoly Results:**

- ‚úÖ 100% prompt compliance (44/44 requirements)
- ‚úÖ 60% CI time reduction (30min ‚Üí 12min)
- ‚úÖ Zero production incidents post-implementation
- ‚úÖ 90-day governance artifact retention
- ‚úÖ 22 test scenarios validated

### Key Performance Indicators (KPIs)

**CI/CD Performance:**

- Average CI duration: <15 minutes
- Cache hit rate: >90%
- Artifact storage: <500MB per month
- Deployment success rate: >99%

**Quality Metrics:**

- Lint/typecheck pass rate: 100% (blocks merge if failing)
- Test coverage: ‚â•80% (maintained)
- Accessibility score: ‚â•95/100 (enforced)
- Performance score: ‚â•90/100 (enforced)

**Governance Metrics:**

- EII score: ‚â•90/100 (human-reviewed before production)
- Ledger integrity: 100% (verified on every run)
- Approval time: <4 hours average (human gate)
- Artifact retention compliance: 100%

---

## 9Ô∏è‚É£ Common Pitfalls & Solutions

### Pitfall 1: Workflow Timeouts

**Problem:** Jobs timeout waiting for build/test completion

**Solution:**

```yaml
jobs:
  quality:
    timeout-minutes: 10 # Adjust based on project size
  accessibility:
    timeout-minutes: 15 # Lighthouse can be slow
```

### Pitfall 2: Cache Invalidation

**Problem:** Stale cache causes failed builds

**Solution:**

```yaml
- uses: actions/setup-node@v4
  with:
    cache: 'npm'
    cache-dependency-path: 'package-lock.json' # Explicit path
```

### Pitfall 3: Secret Leakage

**Problem:** Secrets accidentally logged

**Solution:**

- Never `echo` secrets directly
- Use GitHub Actions automatic masking
- Verify logs before merging workflows

### Pitfall 4: Approval Bottlenecks

**Problem:** Production deployments blocked waiting for approver

**Solution:**

- Configure multiple reviewers in GitHub Environment
- Set up notifications (email, Slack)
- Document on-call rotation for approvals

---

## üîü Related Documentation

### QuantumPoly-Specific

- [CI/CD Prompt Compliance Matrix](../docs/CICD_PROMPT_COMPLIANCE_MATRIX.md) - Requirements validation
- [CI/CD Validation Scenarios](../docs/CICD_VALIDATION_SCENARIOS.md) - Test scenarios
- [CI/CD Testing Guide](../docs/CICD_TESTING_GUIDE.md) - Step-by-step procedures
- [GPG Ledger Integration](../docs/CICD_GPG_LEDGER_INTEGRATION.md) - Security enhancement
- [Simplified CI/CD Example](../docs/examples/SIMPLE_CICD_EXAMPLE.yml) - Educational reference

### General Resources

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Vercel CLI Documentation](https://vercel.com/docs/cli)
- [Next.js Deployment](https://nextjs.org/docs/deployment)
- [TypeScript CI/CD Best Practices](https://www.typescriptlang.org/docs/handbook/project-references.html)

---

## üìã Quick Reference

### Command Cheat Sheet

```bash
# Local validation
npm run lint
npm run typecheck
npm run test -- --coverage
npm run build

# Governance validation
npm run validate:translations
npm run validate:locales
npm run ethics:verify-ledger

# Create production release
git tag v1.0.0
git push origin v1.0.0
gh release create v1.0.0 --title "v1.0.0" --notes "Release notes"

# Verify ledger (if GPG enabled)
gpg --verify governance/ledger/2025-10-19-v1.0.0.json.asc
```

### Troubleshooting Quick Links

| Issue              | Solution Link                                                                                                         |
| ------------------ | --------------------------------------------------------------------------------------------------------------------- |
| CI failing         | [CI/CD Testing Guide ¬ß Troubleshooting](../docs/CICD_TESTING_GUIDE.md#troubleshooting-guide)                          |
| Deployment failing | [CI/CD Validation Scenarios ¬ß Deployment Issues](../docs/CICD_VALIDATION_SCENARIOS.md#2-merge-to-main-flow-scenarios) |
| GPG issues         | [GPG Ledger Integration ¬ß Troubleshooting](../docs/CICD_GPG_LEDGER_INTEGRATION.md#troubleshooting)                    |

---

**Prompt Block Version:** v7.1.0  
**Last Updated:** 2025-10-19  
**Maintained By:** CASP Lead Architect  
**Status:** ‚úÖ Production-Ready
