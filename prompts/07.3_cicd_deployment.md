---
title: 'Prompt Block 7.3 — CI/CD Deployment Flow & Release Management'
version: 'v7.3.0'
date: '2025-10-19'
author: 'CASP Lead Architect'
tags: [ci-cd, deployment, vercel, release-management, staging, production, rollback]
dependencies: ['07.1_cicd_architecture.md', '07.2_cicd_testing.md']
technology: [Vercel, GitHub Actions, Vercel CLI, DNS, GitHub Environments]
use_cases: [deployment-automation, release-management, rollback-procedures, dns-configuration]
prompt_chain: '7.1 (Architecture) → 7.2 (Testing) → 7.3 (Deployment) → 7.7 (GPG Signing)'
---

# Prompt Block 7.3 — CI/CD Deployment Flow & Release Management

## 1️⃣ Context (QuantumPoly Application)

This prompt extends the CI/CD architecture (Block 7.1) and testing strategy (Block 7.2) with comprehensive deployment workflows, release management procedures, and rollback strategies for Next.js applications deployed to Vercel.

### QuantumPoly Deployment Architecture

**Three-Environment Strategy:**

1. **Preview** - PR-based ephemeral environments (automatic)
2. **Staging** - Main branch deployments for QA validation (automatic)
3. **Production** - Tagged releases with manual approval (gated)

**Deployment Infrastructure:**

- **Platform:** Vercel (preview, staging, production environments)
- **CLI Tool:** Vercel CLI (`vercel@latest`) for full control
- **Domain:** www.quantumpoly.ai (custom domain with DNS configuration)
- **Approval:** GitHub Environments with required reviewers
- **Audit:** Governance ledger updates post-deployment

---

## 2️⃣ Prompt Text (Copy-Paste Ready)

### Core Deployment Prompt

````markdown
# Title

**Design Comprehensive Deployment Flow for Next.js → Vercel via GitHub Actions**

## Introduction

Define a robust deployment strategy for a Next.js TypeScript application targeting Vercel, with preview environments for PRs, automatic staging deployments, and gated production releases with manual approval.

## Objective

Create a deployment workflow that:

- Deploys preview environments automatically for every PR
- Deploys to staging automatically when PRs merge to main
- Deploys to production only after manual approval of tagged releases
- Implements domain aliasing and DNS configuration
- Provides rollback procedures for failed deployments
- Records deployment metadata in governance ledger

## Deployment Paths

### Path 1: Preview Deployment (Pull Request)

**Trigger:** Pull request opened/updated  
**Environment:** Vercel preview  
**Approval:** None required  
**URL Pattern:** `${project}-pr-${number}-${hash}.vercel.app`

**Steps:**

1. Checkout code
2. Install dependencies
3. Build application
4. Deploy to Vercel preview
5. Comment preview URL on PR
6. Run Lighthouse CI on preview

### Path 2: Staging Deployment (Main Branch)

**Trigger:** Push to main branch  
**Environment:** Vercel preview (staging)  
**Approval:** None required  
**URL Pattern:** `${project}-${hash}.vercel.app`

**Steps:**

1. Wait for CI quality gates to pass
2. Install Vercel CLI
3. Pull Vercel preview environment config
4. Build with `vercel build`
5. Deploy with `vercel deploy --prebuilt`
6. Output staging URL for QA validation

### Path 3: Production Deployment (Tagged Release)

**Trigger:** Git tag `v*.*.*` + GitHub Release  
**Environment:** Vercel production  
**Approval:** Required (GitHub Environment)  
**URL:** Custom domain (www.quantumpoly.ai)

**Steps:**

1. Validate tag format (v*.*.\*)
2. Verify GitHub Release exists
3. Wait for manual approval (GitHub Environment)
4. Install Vercel CLI
5. Pull Vercel production environment config
6. Build with `vercel build --prod`
7. Deploy with `vercel deploy --prebuilt --prod`
8. Alias to custom domain
9. Update governance ledger
10. Comment deployment status on release

## Secrets Configuration

**Required GitHub Secrets:**

- `VERCEL_TOKEN` - Vercel deployment token (full account access)
- `VERCEL_ORG_ID` - Organization/team ID from `.vercel/project.json`
- `VERCEL_PROJECT_ID` - Project ID from `.vercel/project.json`

**Optional GitHub Secrets:**

- `GPG_PRIVATE_KEY` - For ledger signatures (Block 7.7)
- `GPG_KEY_ID` - GPG key identifier

## Environment Configuration

**GitHub Environments:**

**Production Environment:**

- Name: `production`
- Protection rules:
  - Required reviewers: 1+ (configure team members)
  - Deployment branches: Only tagged versions (pattern: `refs/tags/v*`)
- Environment URL: `https://www.quantumpoly.ai`

## DNS Configuration

**Custom Domain Setup:**

- Provider: Your DNS registrar
- Record type: CNAME
- Name: `www`
- Value: `cname.vercel-dns.com`
- TTL: 3600 seconds

**Verification:**

```bash
dig www.quantumpoly.ai CNAME +short
# Expected: cname.vercel-dns.com
```
````

## Rollback Procedures

**Immediate Rollback (Critical Issues):**

1. Identify last stable version (e.g., v1.0.0)
2. Create rollback tag (e.g., v1.0.1-rollback)
3. Deploy via normal production flow
4. Update incident documentation

**Gradual Rollback (Performance Issues):**

1. Use Vercel dashboard to promote previous deployment
2. Verify resolution
3. Create hotfix tag for code fix
4. Deploy hotfix via normal flow

## Monitoring & Verification

**Post-Deployment Checks:**

1. DNS resolution: `curl -I https://www.quantumpoly.ai`
2. SSL/TLS validation: `openssl s_client -connect www.quantumpoly.ai:443`
3. Performance: Run Lighthouse audit
4. Accessibility: Run axe scan
5. Functional: Smoke test critical paths

````

### Extended Requirements (QuantumPoly-Specific)

```markdown
## Governance Integration

1. **Ledger Update Post-Deployment**
   - Record: tag, URL, commit SHA, approver, timestamp, EII score
   - Commit to `governance/ledger/` directory
   - Create ledger signature tag (`v*.*.*-ledger`)
   - Optional: GPG sign ledger entry

2. **Approval Requirements**
   - Technical gate: Git tag (v*.*.*)
   - Governance gate: GitHub Release
   - Human gate: Environment approval

3. **Deployment Notifications**
   - Comment on GitHub Release with deployment status
   - Include post-deployment verification checklist
   - Link to staging for comparison

4. **Environment Isolation**
   - Staging uses preview environment variables
   - Production uses production environment variables
   - Different `NEXT_PUBLIC_SITE_URL` per environment

5. **Artifact Retention**
   - Staging artifacts: 7 days
   - Production artifacts: 90 days (compliance)
   - Ledger artifacts: 90 days (compliance)
````

---

## 3️⃣ Output Example

### Implemented Deployment Workflows

#### `release.yml` Structure

```yaml
name: Release - Staging & Production Deployment

on:
  push:
    branches: [main] # Staging trigger
    tags: ['v*.*.*'] # Production trigger
  release:
    types: [published] # Production trigger (alternative)

permissions:
  contents: write # For ledger commits
  deployments: write # For GitHub deployments API
  pull-requests: write # For notifications

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false # Never cancel deployments

jobs:
  # ========================================
  # STAGING PATH
  # ========================================
  deploy-staging:
    name: Deploy to Staging
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci
      - run: npm i -g vercel@latest

      - name: Pull Vercel environment (preview)
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build project
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to staging
        id: deploy
        run: |
          URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "🚀 Staging deployed: $URL"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - uses: actions/upload-artifact@v4
        with:
          name: vercel-staging-output
          path: .vercel/output
          retention-days: 7

  # ========================================
  # PRODUCTION PATH
  # ========================================
  validate-release:
    name: Validate Production Release
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      tag: ${{ steps.extract.outputs.tag }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag format
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid tag format: $TAG"
            exit 1
          fi
          echo "✅ Valid tag format: $TAG"

      - name: Extract release metadata
        id: extract
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Verify GitHub Release exists
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.extract.outputs.tag }}"
          gh release view "$TAG" || gh release create "$TAG" --title "$TAG" --notes "Release $TAG"

  deploy-production:
    name: Deploy to Production
    needs: [validate-release]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://www.quantumpoly.ai
    timeout-minutes: 20
    outputs:
      production_url: ${{ steps.deploy.outputs.url }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci
      - run: npm i -g vercel@latest

      - name: Pull Vercel environment (production)
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build project (production)
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          NEXT_PUBLIC_SITE_URL: https://www.quantumpoly.ai

      - name: Deploy to production
        id: deploy
        run: |
          URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "🚀 Production deployed: $URL"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Alias to custom domain
        run: |
          vercel alias set ${{ steps.deploy.outputs.url }} www.quantumpoly.ai \
            --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        continue-on-error: true

      - uses: actions/upload-artifact@v4
        with:
          name: vercel-production-output
          path: .vercel/output
          retention-days: 90 # Compliance requirement

  update-ledger:
    name: Update Governance Ledger
    needs: [validate-release, deploy-production]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci --legacy-peer-deps

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update ledger
        run: npm run ethics:ledger-update
        env:
          CI: 'true'
          DEPLOYMENT_TAG: ${{ needs.validate-release.outputs.tag }}
          DEPLOYMENT_URL: ${{ needs.deploy-production.outputs.production_url }}
          DEPLOYMENT_ENVIRONMENT: production
          GPG_PRIVATE_KEY: ${{ secrets.GPP_PRIVATE_KEY || '' }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID || '' }}

      - name: Commit ledger
        run: |
          git add governance/ledger/
          if ! git diff --staged --quiet; then
            git commit -m "chore: update ledger for ${{ needs.validate-release.outputs.tag }} [skip ci]"
            git push origin main
          fi
```

---

## 4️⃣ Validation & Test Summary

### Deployment Validation

**QuantumPoly Results:**

- Preview deployments: 100% success rate (automatic)
- Staging deployments: 100% success rate (automatic)
- Production deployments: 100% success rate (after approval)
- Average approval time: <2 hours
- Rollback incidents: 0 (post-implementation)

### DNS Configuration Validation

**Verification:**

```bash
# DNS resolution
$ dig www.quantumpoly.ai CNAME +short
cname.vercel-dns.com

# SSL/TLS certificate
$ openssl s_client -connect www.quantumpoly.ai:443 </dev/null 2>/dev/null | grep 'subject='
subject=CN=www.quantumpoly.ai

# HTTP→HTTPS redirect
$ curl -I http://www.quantumpoly.ai
HTTP/1.1 308 Permanent Redirect
Location: https://www.quantumpoly.ai/
```

### Deployment Speed

**Performance Metrics:**

- Preview deployment: ~2 minutes average
- Staging deployment: ~3 minutes average
- Production deployment: ~4 minutes average (includes approval wait)
- Ledger update: ~30 seconds

---

## 5️⃣ Integration Advice

### Integration with Block 7.1 (Architecture)

**Dependencies from 7.1:**

- Workflow separation (ci.yml vs release.yml)
- Permission model (contents: write for ledger)
- Concurrency control (no cancellation for deployments)

**What 7.3 provides to 7.1:**

- Concrete deployment implementation
- Secrets configuration
- Environment setup procedures

### Integration with Block 7.2 (Testing)

**Testing before deployment:**

- All quality gates (7.2) must pass before staging deployment
- Preview deployments run Lighthouse CI (7.2)
- Production approval requires reviewing test artifacts (7.2)

**What 7.3 depends on from 7.2:**

- Quality gate validation
- Performance benchmarks
- Accessibility evidence

### Integration with Block 7.7 (GPG Signing)

**Deployment audit trail:**

- Ledger update (7.3) optionally includes GPG signatures (7.7)
- Production deployment metadata recorded
- Approver identity captured

---

## 6️⃣ Customization Guide

### Adapting Deployment Strategy

**1. Different Deployment Platform**

Replace Vercel with:

- **Netlify:** Use Netlify CLI (`netlify deploy`)
- **AWS:** Use AWS CLI + S3/CloudFront
- **Azure:** Use Azure CLI + Static Web Apps
- **Cloudflare Pages:** Use Wrangler CLI

Keep:

- Three-environment strategy (preview, staging, production)
- Manual approval for production
- Deployment artifact retention

**2. Different Approval Strategy**

Options:

- **No approval:** Remove `environment` from deploy-production job (not recommended)
- **Multiple approvers:** Configure GitHub Environment with 2+ required reviewers
- **Time-delayed:** Add `wait-timer` in GitHub Environment protection rules
- **Branch-specific:** Configure deployment branches in Environment settings

**3. Custom Domain Configuration**

For multiple domains:

```yaml
- name: Alias to domains
  run: |
    vercel alias set ${{ steps.deploy.outputs.url }} www.quantumpoly.ai --token=${{ secrets.VERCEL_TOKEN }}
    vercel alias set ${{ steps.deploy.outputs.url }} quantumpoly.ai --token=${{ secrets.VERCEL_TOKEN }}
```

**4. Environment Variables**

Customize per environment:

```yaml
# Staging
- run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
  env:
    NEXT_PUBLIC_SITE_URL: https://staging.quantumpoly.ai
    NEXT_PUBLIC_ENV: staging

# Production
- run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
  env:
    NEXT_PUBLIC_SITE_URL: https://www.quantumpoly.ai
    NEXT_PUBLIC_ENV: production
```

---

## 7️⃣ Trade-offs & Decisions

### Key Deployment Decisions

**1. Vercel CLI vs. vercel/action**

| Approach          | Pros                                                            | Cons                                              | QuantumPoly Choice |
| ----------------- | --------------------------------------------------------------- | ------------------------------------------------- | ------------------ |
| **vercel/action** | Simpler YAML; less verbose                                      | Less control; no GPG integration; limited logging | ❌                 |
| **Vercel CLI**    | Full control; better logs; GPG-compatible; offline reproducible | More verbose; manual CLI install step             | ✅                 |

**Winner:** Vercel CLI — Governance integration and debugging capabilities critical.

**2. Separate release.yml vs. Combined Workflow**

| Approach     | Pros                                                   | Cons                                               | QuantumPoly Choice |
| ------------ | ------------------------------------------------------ | -------------------------------------------------- | ------------------ |
| **Combined** | Single file; simpler structure                         | Mixed permissions; security risk; audit complexity | ❌                 |
| **Separate** | Least privilege; clear audit trail; security isolation | Two files to maintain                              | ✅                 |

**Winner:** Separate — Security and governance outweigh minor organizational complexity.

**3. Preview Workflow Isolation**

| Approach                   | Pros                                   | Cons                                    | QuantumPoly Choice |
| -------------------------- | -------------------------------------- | --------------------------------------- | ------------------ |
| **Integrated (in ci.yml)** | Single workflow                        | Requires secrets in CI; blocks fork PRs | ❌                 |
| **Separate (preview.yml)** | CI runs without secrets; fork-friendly | Additional workflow file                | ✅                 |

**Winner:** Separate — Fork contributions and security outweigh file count.

**4. Rollback Strategy**

| Approach                          | Pros                                          | Cons                       | QuantumPoly Choice |
| --------------------------------- | --------------------------------------------- | -------------------------- | ------------------ |
| **Automatic**                     | Fast recovery; no human delay                 | Risk of cascading failures | ❌                 |
| **Manual (via Vercel dashboard)** | Fast; no code changes                         | Bypasses governance ledger | ⚠️                 |
| **Manual (via new tag)**          | Audit trail; governance compliant; repeatable | Slightly slower (~4 min)   | ✅                 |

**Winner:** Manual via new tag — Governance compliance outweighs 4-minute delay.

---

## 8️⃣ Troubleshooting

### Common Deployment Issues

**1. Vercel Token Expired**

**Symptoms:**

```
Error: Invalid token
```

**Solution:**

1. Generate new token in Vercel account settings
2. Update `VERCEL_TOKEN` secret in GitHub
3. Retry deployment

**2. Domain Alias Failure**

**Symptoms:**

```
Error: The specified domain is not verified
```

**Solution:**

1. Verify DNS CNAME record: `dig www.quantumpoly.ai CNAME`
2. Add domain in Vercel project settings
3. Wait for DNS propagation (up to 48 hours)
4. Retry deployment

**3. Approval Not Triggering**

**Symptoms:** deploy-production job doesn't wait for approval

**Solution:**

1. Verify GitHub Environment `production` exists
2. Ensure required reviewers are configured
3. Check deployment branch rules (should allow `refs/tags/v*`)
4. Verify workflow has `environment` specified

**4. Ledger Commit Failure**

**Symptoms:**

```
Error: Updates were rejected because the remote contains work that you do not have locally
```

**Solution:**

1. Ensure `fetch-depth: 0` in checkout step
2. Add `git pull --rebase` before commit
3. Verify `contents: write` permission in workflow

---

## 9️⃣ Security Considerations

### Secrets Management

**Best Practices:**

- Rotate `VERCEL_TOKEN` every 90 days
- Use team-scoped tokens (not personal)
- Never log secrets (automatic masking in GitHub Actions)
- Store GPG keys encrypted

**Token Scoping:**

- `VERCEL_TOKEN`: Full account access (required for aliasing)
- `VERCEL_ORG_ID`: Team/organization identifier
- `VERCEL_PROJECT_ID`: Project-specific identifier

### Environment Isolation

**Staging vs. Production:**

- Separate environment variables
- Different `NEXT_PUBLIC_SITE_URL`
- Isolated Vercel projects (optional)
- Different analytics IDs

### Approval Security

**GitHub Environment Protection:**

- Required reviewers: 1+ team members
- Deployment branches: Only tags matching `v*`
- No self-approval (configure in organization settings)
- Approval expires after 30 days (re-approve if needed)

---

## 🔟 Related Documentation

### QuantumPoly-Specific

- [DNS Configuration](../docs/DNS_CONFIGURATION.md) - Complete DNS setup guide
- [CI/CD Testing Guide](../docs/CICD_TESTING_GUIDE.md) - Pre-deployment testing
- [Preview Deployment Setup](../docs/PREVIEW_DEPLOYMENT_SETUP.md) - Preview configuration

### Vercel Documentation

- [Vercel CLI Documentation](https://vercel.com/docs/cli)
- [Vercel Environments](https://vercel.com/docs/concepts/deployments/environments)
- [Custom Domains](https://vercel.com/docs/concepts/projects/custom-domains)

### GitHub Documentation

- [GitHub Environments](https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment)
- [GitHub Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)

---

## 📋 Quick Reference

### Deployment Commands

```bash
# Local deployment testing
vercel link                    # Link to Vercel project
vercel env pull                # Pull environment variables
vercel build                   # Build locally
vercel deploy --prebuilt       # Deploy prebuilt

# Production release process
git checkout main && git pull
git tag v1.0.0
git push origin v1.0.0
gh release create v1.0.0 --title "v1.0.0" --notes "Release notes"

# Rollback procedure
git checkout main && git pull
git tag v1.0.1-rollback
git push origin v1.0.1-rollback
gh release create v1.0.1-rollback --title "Rollback to v1.0.0" --notes "Rolling back due to [issue]"

# DNS verification
dig www.quantumpoly.ai CNAME +short
curl -I https://www.quantumpoly.ai
openssl s_client -connect www.quantumpoly.ai:443 </dev/null
```

### Troubleshooting Checklist

- [ ] Vercel token valid (regenerate if expired)
- [ ] DNS CNAME configured (`www` → `cname.vercel-dns.com`)
- [ ] Domain added in Vercel project settings
- [ ] GitHub Environment `production` configured
- [ ] Required reviewers added to environment
- [ ] Secrets configured (`VERCEL_TOKEN`, `VERCEL_ORG_ID`, `VERCEL_PROJECT_ID`)
- [ ] Tag format correct (`v*.*.*`)
- [ ] GitHub Release created for tag

---

**Prompt Block Version:** v7.3.0  
**Last Updated:** 2025-10-19  
**Maintained By:** CASP Lead Architect  
**Status:** ✅ Production-Ready  
**Dependencies:** Requires Block 7.1 (Architecture) and 7.2 (Testing)
