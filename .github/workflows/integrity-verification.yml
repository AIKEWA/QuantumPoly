name: Integrity Verification

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:  # Enable manual trigger for Day 0 bootstrap

permissions:
  contents: read

jobs:
  verify-integrity:
    name: Verify System Integrity
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: Run integrity verification
        id: integrity
        run: npm run integrity:verify
        env:
          NODE_ENV: production
        continue-on-error: true
        
      - name: Verify ledger consistency
        run: npm run ethics:verify-ledger
        continue-on-error: true
        
      - name: Verify consent compliance
        run: npm run consent:verify
        continue-on-error: true
        
      - name: Upload integrity reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integrity-verification-${{ github.run_number }}
          path: |
            governance/integrity/reports/*.json
            reports/*.json
          retention-days: 90
          if-no-files-found: warn
          
      - name: Generate integrity summary
        if: always()
        run: |
          echo "## Integrity Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Node Version:** 20 (Stage VI environment match)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find latest integrity report
          INTEGRITY_FILE=$(ls -t governance/integrity/reports/*.json 2>/dev/null | head -1)
          if [ -n "$INTEGRITY_FILE" ] && [ -f "$INTEGRITY_FILE" ]; then
            echo "✅ Integrity verification completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Verification Results" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            jq '{timestamp, status, checks: .checks | length, passed: [.checks[] | select(.status == "passed")] | length}' "$INTEGRITY_FILE" 2>/dev/null || head -20 "$INTEGRITY_FILE"
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No integrity report generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Governance Chain Status" >> $GITHUB_STEP_SUMMARY
          if [ -f governance/ledger/ledger.jsonl ]; then
            ENTRY_COUNT=$(wc -l < governance/ledger/ledger.jsonl)
            echo "- Ledger entries: $ENTRY_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- Latest entry: $(tail -1 governance/ledger/ledger.jsonl | jq -r '.timestamp // "N/A"')" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Ledger file not found" >> $GITHUB_STEP_SUMMARY
          fi
