name: Daily Governance Report

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:  # Enable manual trigger for Day 0 bootstrap

permissions:
  contents: read

jobs:
  generate-report:
    name: Generate Daily Governance Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: Generate daily governance report
        run: npm run report:daily
        env:
          NODE_ENV: production
          
      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: daily-governance-report-${{ github.run_number }}
          path: |
            reports/monitoring-*.json
            reports/monitoring/*.json
          retention-days: 90
          if-no-files-found: warn
          
      - name: Report summary
        if: always()
        run: |
          echo "## Daily Governance Report Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f reports/monitoring-$(date -u +%Y-%m-%d).json ]; then
            echo "✅ Report generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Report Preview" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            head -n 20 reports/monitoring-$(date -u +%Y-%m-%d).json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Report file not found" >> $GITHUB_STEP_SUMMARY
          fi
