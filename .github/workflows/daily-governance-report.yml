name: Daily Governance Report

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:  # Enable manual trigger for Day 0 bootstrap

permissions:
  contents: read

jobs:
  generate-report:
    name: Generate Daily Governance Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Diagnostics
        run: |
          echo "Node: $(node -v)"
          echo "npm: $(npm -v)"
          echo "package.json: $(test -f package.json && echo present || echo missing)"
          echo "package-lock.json: $(test -f package-lock.json && echo present || echo missing)"
          echo "governance/ledger/ledger.jsonl: $(test -f governance/ledger/ledger.jsonl && echo present || echo missing)"

      - name: Install dependencies
        run: npm ci

      - name: Generate daily governance report
        id: report
        run: |
          set +e
          npm run report:daily
          REPORT_EXIT=$?
          echo "exit_code=$REPORT_EXIT" >> $GITHUB_OUTPUT
          if [ "$REPORT_EXIT" -ne 0 ]; then
            echo "::warning::report:daily exited with code $REPORT_EXIT (warnings may be expected when optional data sources are missing)."
          fi
        env:
          NODE_ENV: production

      - name: Validate report output
        run: |
          REPORT_FILE="reports/monitoring-$(date -u +%Y-%m-%d).json"
          if [ ! -f "$REPORT_FILE" ]; then
            echo "❌ Report file missing: $REPORT_FILE"
            exit 1
          fi
          echo "✅ Report file present: $REPORT_FILE"

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: daily-governance-report-${{ github.run_number }}
          path: |
            reports/monitoring-*.json
            reports/monitoring/*.json
          retention-days: 90
          if-no-files-found: warn
          
      - name: Report summary
        if: always()
        run: |
          echo "## Daily Governance Report Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**report:daily exit code:** ${{ steps.report.outputs.exit_code }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f reports/monitoring-$(date -u +%Y-%m-%d).json ]; then
            echo "✅ Report generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Report Preview" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            head -n 20 reports/monitoring-$(date -u +%Y-%m-%d).json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Report file not found" >> $GITHUB_STEP_SUMMARY
          fi
