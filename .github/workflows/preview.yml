name: Preview Deployment

on:
  pull_request:
    branches: [ main ]

jobs:
  preview:
    name: Deploy Preview (Vercel)
    runs-on: ubuntu-latest
    outputs:
      preview_url: ${{ steps.deploy.outputs.preview_url }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Install Vercel CLI
        run: npm i -g vercel@latest

      - name: Pull Vercel env (preview)
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build (prebuilt output)
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - id: deploy
        name: Deploy preview
        run: |
          URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "preview_url=$URL" >> "$GITHUB_OUTPUT"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Upload prebuilt artifact
        uses: actions/upload-artifact@v4
        with:
          name: vercel-prebuilt
          path: .vercel/output

      - name: Comment preview URL on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `üöÄ **Preview deployed:** ${{ steps.deploy.outputs.preview_url }}
            
            ## Preview Links
            - üåê [Main Page](${{ steps.deploy.outputs.preview_url }})
            - üìö [Storybook](${{ steps.deploy.outputs.preview_url }}/storybook-static)
            
            ## Quality Gates
            - ‚úÖ Lighthouse CI will run against this preview
            - ‚úÖ Accessibility score must be 1.0
            - ‚ö†Ô∏è Performance & SEO scores should be ‚â• 0.9
            `;
            
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body
            });

  lighthouse:
    name: Lighthouse CI (Preview)
    runs-on: ubuntu-latest
    needs: preview
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          
      - name: Install LHCI
        run: npm i -D @lhci/cli && npm ci

      - name: Wait for preview to be ready
        id: wait_ready
        run: |
          PREVIEW_URL="${{ needs.preview.outputs.preview_url }}"
          echo "Checking preview URL: $PREVIEW_URL"
          
          MAX_ATTEMPTS=12
          WAIT_SECONDS=10
          
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "--- Attempt $i/$MAX_ATTEMPTS ---"
            
            # Capture HTTP status and final URL after redirects
            RESPONSE=$(curl -sS -L -o /dev/null -w "HTTP_CODE=%{http_code}\nFINAL_URL=%{url_effective}\nREDIRECT_COUNT=%{num_redirects}" "$PREVIEW_URL" 2>&1) || true
            echo "$RESPONSE"
            
            HTTP_CODE=$(echo "$RESPONSE" | grep HTTP_CODE | cut -d= -f2)
            FINAL_URL=$(echo "$RESPONSE" | grep FINAL_URL | cut -d= -f2)
            
            # Detect auth redirect (login pages, SSO)
            if echo "$FINAL_URL" | grep -qiE "(login|auth|signin|sso|vercel\.com/login)"; then
              echo "::error::Preview URL redirects to auth page: $FINAL_URL"
              echo "::error::Vercel preview protection may be enabled. Disable it or allowlist the LHCI runner."
              exit 1
            fi
            
            # Check for success
            if [ "$HTTP_CODE" = "200" ]; then
              echo "Preview is ready (HTTP 200)"
              echo "ready=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            
            # Check for permanent failure (4xx except 404 which might be transient)
            if [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ]; then
              echo "::error::Preview URL returned $HTTP_CODE - access denied"
              echo "::error::Check Vercel preview protection settings"
              exit 1
            fi
            
            echo "HTTP $HTTP_CODE - waiting ${WAIT_SECONDS}s..."
            sleep $WAIT_SECONDS
          done
          
          echo "::error::Preview URL not ready after $((MAX_ATTEMPTS * WAIT_SECONDS))s"
          echo "::error::Last HTTP status: $HTTP_CODE"
          exit 1

      - name: Run Lighthouse CI (strict a11y)
        env:
          LHCI_MODE: external_url
          PREVIEW_URL: ${{ needs.preview.outputs.preview_url }}
        run: npx lhci autorun
        
      - name: Comment Lighthouse results on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## üîç Lighthouse CI Results
            
            Preview URL tested: ${{ needs.preview.outputs.preview_url }}
            
            **Quality Gates:**
            - üéØ Accessibility: Required score = 1.0
            - ‚ö° Performance: Warning if < 0.9
            - üîç SEO: Warning if < 0.9
            - ‚ú® Best Practices: Warning if < 0.9
            
            Check the full report in the workflow logs above.
            `;
            
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body
            });
