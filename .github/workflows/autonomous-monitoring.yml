name: Autonomous System Monitoring

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:  # Enable manual trigger for Day 0 bootstrap

permissions:
  contents: read

jobs:
  monitor-system:
    name: Monitor System Health
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.17.25'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: Run system monitoring
        run: npm run monitor
        env:
          NODE_ENV: production
        continue-on-error: true
        
      - name: Upload monitoring artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: system-monitoring-${{ github.run_number }}
          path: |
            reports/monitoring/*.json
            reports/monitoring-*.json
          retention-days: 90
          if-no-files-found: warn
          
      - name: Check system health status
        if: always()
        run: |
          echo "## System Monitoring Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** https://www.quantumpoly.ai" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find the latest monitoring file
          LATEST_FILE=$(ls -t reports/monitoring/*.json 2>/dev/null | head -1)
          if [ -n "$LATEST_FILE" ] && [ -f "$LATEST_FILE" ]; then
            echo "✅ Monitoring completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Health Check Summary" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            jq '.summary // . | {status, timestamp, checks_passed: .checks_passed // "N/A"}' "$LATEST_FILE" 2>/dev/null || cat "$LATEST_FILE" | head -20
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No monitoring data generated" >> $GITHUB_STEP_SUMMARY
          fi
