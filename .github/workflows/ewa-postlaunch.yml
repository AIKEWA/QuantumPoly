name: EWA Post-Launch Monitoring

on:
  schedule:
    # Run daily at 02:00 UTC (offset from other daily jobs)
    - cron: '0 2 * * *'
  workflow_dispatch:  # Enable manual trigger for Day 0 bootstrap

permissions:
  contents: read

jobs:
  ewa-postlaunch:
    name: EWA Ethics & Accessibility Monitoring
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.17.25'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: Run EWA post-launch monitoring
        id: ewa
        run: npm run postlaunch:monitor
        env:
          NODE_ENV: production
        continue-on-error: true
        
      - name: Verify ethics reporting
        run: npm run ethics:verify-reporting
        continue-on-error: true
        
      - name: Run EWA analysis
        run: npm run ewa:analyze
        continue-on-error: true
        
      - name: Upload EWA artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ewa-postlaunch-${{ github.run_number }}
          path: |
            reports/postlaunch-*.json
            reports/ethics/*.json
          retention-days: 90
          if-no-files-found: warn
          
      - name: Generate EWA summary
        if: always()
        run: |
          echo "## EWA Post-Launch Monitoring Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Monitoring Target:** https://www.quantumpoly.ai" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for postlaunch status report
          POSTLAUNCH_FILE="reports/postlaunch-status-$(date -u +%Y-%m-%d).json"
          if [ -f "$POSTLAUNCH_FILE" ]; then
            echo "✅ EWA monitoring completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Ethics & Accessibility Status" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            jq '{
              ethics: {
                score: .ethics.ethics_score,
                status: .ethics.status
              },
              accessibility: {
                score: .accessibility.a11y_score,
                violations: .accessibility.violations_count
              },
              trust: {
                score: .trust.trust_score,
                proofs: .trust.active_proofs
              }
            }' "$POSTLAUNCH_FILE" 2>/dev/null || head -30 "$POSTLAUNCH_FILE"
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Post-launch status file not found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Expected: \`$POSTLAUNCH_FILE\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Governance Alignment" >> $GITHUB_STEP_SUMMARY
          echo "- Ethics transparency: Verified" >> $GITHUB_STEP_SUMMARY
          echo "- Accessibility compliance: Monitored" >> $GITHUB_STEP_SUMMARY
          echo "- Trust proof validity: Checked" >> $GITHUB_STEP_SUMMARY
