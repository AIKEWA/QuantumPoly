# NOTE: Superseded by .github/workflows/ci.yml; this workflow is manual-only (workflow_dispatch).
name: Accessibility CI - Ethical Enforcement

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  eslint-a11y:
    name: ESLint jsx-a11y Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint with jsx-a11y rules
        run: npm run lint

  jest-axe-tests:
    name: Jest-Axe Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run jest-axe accessibility tests
        run: npm run test:a11y

  playwright-axe-e2e:
    name: Playwright Axe E2E Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      
      - name: Build application
        run: npm run build
      
      - name: Run Playwright a11y E2E tests
        run: npm run test:e2e:a11y
      
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-a11y-report
          path: playwright-report/
          retention-days: 30

  lighthouse-audit:
    name: Lighthouse A11y & Performance (â‰¥95, â‰¥90)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        run: npm run build
      
      - name: Start production server
        run: |
          npm run start &
          echo $! > server.pid
        env:
          PORT: 3000
      
      - name: Wait for server
        run: npx wait-on http://localhost:3000 --timeout 60000
      
      - name: Run Lighthouse Audit (A11y â‰¥95, Perf â‰¥90)
        run: npm run lh:a11y
        env:
          LH_URL: http://localhost:3000/en
      
      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi
      
      - name: Upload Lighthouse Accessibility Evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-accessibility-evidence
          path: reports/lighthouse/
          retention-days: 90
      
      - name: Display Lighthouse Summary
        if: always()
        run: |
          if [ -f reports/lighthouse/summary.json ]; then
            echo "ðŸ“Š Lighthouse Audit Summary:"
            cat reports/lighthouse/summary.json
          fi
